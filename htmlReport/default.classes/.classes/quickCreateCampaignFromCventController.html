


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: quickCreateCampaignFromCventController</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">default.classes</a> ]
</div>

<h1>Coverage Summary for Class: quickCreateCampaignFromCventController (default.classes)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">quickCreateCampaignFromCventController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    78.7%
  </span>
  <span class="absValue">
    (192/ 244)
  </span>
</td>
</tr>

</table>

<br/>
<br/>

<h2>quickCreateCampaignFromCventController</h2>
<div class="sourceCode"><i>1</i>&nbsp;/*-------------------------------------------------------------------------------------------------------
<i>2</i>&nbsp;Author:         Houssam ADIB (Salesforce)
<i>3</i>&nbsp;Description:    LWC:quickCreateCampaignFromCvent  Controller
<i>4</i>&nbsp;Test class      CreateCampaignFromCventControllerTest
<i>5</i>&nbsp;
<i>6</i>&nbsp;History
<i>7</i>&nbsp;01-01-2023     Houssam ADIB - Create new class
<i>8</i>&nbsp;01-01-2024     Houssam ADIB - Refactoring and adding Phase 2 ( Sales Lead Generation )
<i>9</i>&nbsp;01-10-2024     Houssam ADIB - TFUS-000006858 - Map new fields from Temp to attendee ( static mapping ) + Add logic to SharedGlobally field
<i>10</i>&nbsp;
<i>11</i>&nbsp;----------------------------------------------------------------------------------------*/
<i>12</i>&nbsp;public without sharing class quickCreateCampaignFromCventController {
<i>13</i>&nbsp;
<i>14</i>&nbsp;    private static Id linkedCampaign;
<i>15</i>&nbsp;
<i>16</i>&nbsp;    /** STAGE 1
<i>17</i>&nbsp;     * Root method that gets called in the front to create a campaign based on a Cvent Event record.
<i>18</i>&nbsp;     * @author hadib@salesforce.com | 10-01-2023
<i>19</i>&nbsp;     *
<i>20</i>&nbsp;     * @param cventCode     The Cvent Event code entered by the user
<i>21</i>&nbsp;     * @param mainBrand     Main Brand selected in the UI
<i>22</i>&nbsp;     * @param convertMembersToSalesLeads     Set Campaign Convert To = &#39;Sales Lead&#39;
<i>23</i>&nbsp;     *
<i>24</i>&nbsp;     * @return ResultWrapper -  We return a wrapper in both success and failure use cases
<i>25</i>&nbsp;     *                          We never throw a handledException because we report the Error logs in DB
<i>26</i>&nbsp;     */
<i>27</i>&nbsp;    @AuraEnabled
<b class="fc"><i>28</i>&nbsp;    public static ResultWrapper createCampaignFromCvent(String cventCode, String mainBrand, Boolean convertMembersToSalesLeads)</b>
<i>29</i>&nbsp;    {
<b class="fc"><i>30</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<i>31</i>&nbsp;
<i>32</i>&nbsp;        // Step 1 - Validate the user entry
<b class="fc"><i>33</i>&nbsp;        if(String.isBlank(cventCode))</b>
<i>34</i>&nbsp;        {
<b class="fc"><i>35</i>&nbsp;            validateDynamicMappingsAsync();</b>
<b class="fc"><i>36</i>&nbsp;            result.error    = &#39;Invalid Entry!&#39;;</b>
<b class="fc"><i>37</i>&nbsp;            result.status   = &#39;Error&#39;;</b>
<b class="fc"><i>38</i>&nbsp;            return result;</b>
<i>39</i>&nbsp;        }
<i>40</i>&nbsp;
<b class="fc"><i>41</i>&nbsp;        try</b>
<i>42</i>&nbsp;        {
<i>43</i>&nbsp;            // Step 2 - Validations
<b class="fc"><i>44</i>&nbsp;            List&lt;CventEvents__Event__c&gt; sourceCvent = CventManagement.findCventByCode(cventCode);</b>
<b class="fc"><i>45</i>&nbsp;            ResultWrapper errorResultWrapper = getErrorResultWrapper(sourceCvent, cventCode);</b>
<i>46</i>&nbsp;
<i>47</i>&nbsp;            // Step 3 - Trigger Campaign Creation
<b class="fc"><i>48</i>&nbsp;            if(errorResultWrapper != null)</b>
<i>49</i>&nbsp;            {
<b class="fc"><i>50</i>&nbsp;                return errorResultWrapper;</b>
<i>51</i>&nbsp;            }
<i>52</i>&nbsp;            else {
<b class="fc"><i>53</i>&nbsp;                result = startCreationProcess(sourceCvent[0],mainBrand,convertMembersToSalesLeads);</b>
<i>54</i>&nbsp;            }
<i>55</i>&nbsp;        }
<i>56</i>&nbsp;        catch (Exception e)
<b class="nc"><i>57</i>&nbsp;        {</b>
<b class="nc"><i>58</i>&nbsp;            Database.SaveResult savingErrorLogResult = DebugLog.addException(e, &#39;quickCreateCampaignFromCventController.createCampaignFromCvent&#39;);</b>
<b class="nc"><i>59</i>&nbsp;            result.error = e;</b>
<b class="nc"><i>60</i>&nbsp;            if(savingErrorLogResult.isSuccess())</b>
<i>61</i>&nbsp;            {
<b class="nc"><i>62</i>&nbsp;                result.errorDebugLogId = savingErrorLogResult.getId();</b>
<i>63</i>&nbsp;            }
<i>64</i>&nbsp;        }
<i>65</i>&nbsp;
<b class="fc"><i>66</i>&nbsp;        return result;</b>
<i>67</i>&nbsp;    }
<i>68</i>&nbsp;
<i>69</i>&nbsp;    /**
<i>70</i>&nbsp;     * Runs Validations on entered Cvent Event Code.
<i>71</i>&nbsp;     * @author hadib@salesforce.com | 27-12-2023
<i>72</i>&nbsp;     * @param sourceCvent Source Event
<i>73</i>&nbsp;     * @param cventCode Cvent Event Code
<i>74</i>&nbsp;     *
<i>75</i>&nbsp;     * @return ResultWrapper
<i>76</i>&nbsp;     */
<b class="fc"><i>77</i>&nbsp;    public static ResultWrapper getErrorResultWrapper(List&lt;CventEvents__Event__c&gt; sourceCvent, String cventCode)</b>
<i>78</i>&nbsp;    {
<i>79</i>&nbsp;        // Validation 1 - We check if the code entered doesn&#39;t correspond to any Cvent Event record
<b class="fc"><i>80</i>&nbsp;        if (sourceCvent.isEmpty()) {</b>
<b class="fc"><i>81</i>&nbsp;            validateDynamicMappingsAsync();</b>
<b class="fc"><i>82</i>&nbsp;            return errorCodeNotFound(cventCode);</b>
<i>83</i>&nbsp;        }
<i>84</i>&nbsp;        // Validation 2 -   The user has entered a valid code, but the Cvent event pointed may already have a campaign linked,
<i>85</i>&nbsp;        //                  if its the case we return an error
<i>86</i>&nbsp;        else{
<b class="fc"><i>87</i>&nbsp;            if (alreadyLinkedToACampaign(sourceCvent[0])) {</b>
<b class="fc"><i>88</i>&nbsp;                validateDynamicMappingsAsync();</b>
<b class="fc"><i>89</i>&nbsp;                return errorAlreadyLinkedToACampaign(linkedCampaign, cventCode);</b>
<i>90</i>&nbsp;            }
<i>91</i>&nbsp;        }
<b class="fc"><i>92</i>&nbsp;        return null;</b>
<i>93</i>&nbsp;    }
<i>94</i>&nbsp;
<i>95</i>&nbsp;    /**
<i>96</i>&nbsp;     * Trigger Asynchronous Validations to Dynamic mapping if there any new ones added.
<i>97</i>&nbsp;     * @author hadib@salesforce.com | 27-12-2023
<i>98</i>&nbsp;     */
<b class="fc"><i>99</i>&nbsp;    public static void validateDynamicMappingsAsync()</b>
<i>100</i>&nbsp;    {
<b class="fc"><i>101</i>&nbsp;        MappingManagement.launchValidationAsynchronous(CventManagement.SOURCE_OBJECT_EVENT, CventManagement.TARGET_OBJECT_CAMPAIGN);</b>
<b class="fc"><i>102</i>&nbsp;        MappingManagement.launchValidationAsynchronous(CventManagement.SOURCE_OBJECT_TEMP, CventManagement.TARGET_OBJECT_LEAD);</b>
<i>103</i>&nbsp;    }
<i>104</i>&nbsp;
<i>105</i>&nbsp;    /** STAGE 2
<i>106</i>&nbsp;     * Root Method that converts unmatched Temp Attendee to Attendees+Leads
<i>107</i>&nbsp;     * We just create the leads in this step, and prepare the attendees to be created in a later step.
<i>108</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>109</i>&nbsp;     *
<i>110</i>&nbsp;     * @param cventCode Event Code
<i>111</i>&nbsp;     *
<i>112</i>&nbsp;     * @return ResultWrapper - Result Wrapper
<i>113</i>&nbsp;     */
<i>114</i>&nbsp;    @AuraEnabled
<b class="fc"><i>115</i>&nbsp;    public static ResultWrapper convertTempAttendeesToLeads(String cventCode)</b>
<i>116</i>&nbsp;    {
<b class="fc"><i>117</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<b class="fc"><i>118</i>&nbsp;        List&lt;AttendeeWrapper&gt; attendeeWrappers = new List&lt;AttendeeWrapper&gt;();</b>
<i>119</i>&nbsp;
<b class="fc"><i>120</i>&nbsp;        try</b>
<i>121</i>&nbsp;        {
<i>122</i>&nbsp;            // Find Cvent Event
<b class="fc"><i>123</i>&nbsp;            List&lt;CventEvents__Event__c&gt; sourceCvent = CventManagement.findCventByCode(cventCode);</b>
<b class="fc"><i>124</i>&nbsp;            List&lt;DynamicMapping__mdt&gt; mappings = MappingManagement.getMapping(CventManagement.SOURCE_OBJECT_TEMP, CventManagement.TARGET_OBJECT_LEAD,true);</b>
<b class="fc"><i>125</i>&nbsp;            Map&lt;String,CventEvents__AttendeeTemp__c&gt; allTemps = getAllTemps(sourceCvent,mappings);</b>
<i>126</i>&nbsp;            // Find existing leads by stub in case we already generated leads for temps
<b class="fc"><i>127</i>&nbsp;            Map&lt;String, Lead&gt; stubToLead = CventManagement.getStubToLead();</b>
<i>128</i>&nbsp;
<i>129</i>&nbsp;
<i>130</i>&nbsp;            // Find existing matched Attendees
<b class="fc"><i>131</i>&nbsp;            Map&lt;String,CventEvents__Attendee__c&gt; matchedAttendees = CventManagement.getMatchedAttendees(sourceCvent[0]);</b>
<i>132</i>&nbsp;
<i>133</i>&nbsp;            // Partition Temps in matched and unmatched
<b class="fc"><i>134</i>&nbsp;            Map&lt;String,CventEvents__AttendeeTemp__c&gt; matchedTempAttendees = new Map&lt;String,CventEvents__AttendeeTemp__c&gt;();</b>
<b class="fc"><i>135</i>&nbsp;            Map&lt;Id,CventEvents__AttendeeTemp__c&gt; unmatchedTempAttendees = new Map&lt;Id,CventEvents__AttendeeTemp__c&gt;();</b>
<b class="fc"><i>136</i>&nbsp;            partitionTemps(allTemps, matchedAttendees.keySet(),     // Input</b>
<b class="fc"><i>137</i>&nbsp;                    matchedTempAttendees, unmatchedTempAttendees);  // will be Output</b>
<i>138</i>&nbsp;
<i>139</i>&nbsp;            // Put matched attendees in wrappers to prepare for recreation (recreating the attendees is the only way to secure conversion to member by cvent app)
<b class="fc"><i>140</i>&nbsp;            attendeeWrappers.addAll(prepareMatchedAttendeesForReCreation(sourceCvent, matchedAttendees, matchedTempAttendees));</b>
<i>141</i>&nbsp;
<i>142</i>&nbsp;
<i>143</i>&nbsp;
<i>144</i>&nbsp;            // Create Leads for unmatched Temps
<b class="fc"><i>145</i>&nbsp;            List&lt;Lead&gt; newLeads = new List&lt;Lead&gt;();</b>
<b class="fc"><i>146</i>&nbsp;            List&lt;CventEvents__AttendeeTemp__c&gt; newTempsConvertedToLeads = new List&lt;CventEvents__AttendeeTemp__c&gt;();</b>
<i>147</i>&nbsp;
<b class="fc"><i>148</i>&nbsp;            newLeads = CventManagement.InstantiateLeadsForUnmatchedTemps(   unmatchedTempAttendees.values(), newTempsConvertedToLeads, sourceCvent[0],</b>
<b class="fc"><i>149</i>&nbsp;                    mappings, stubToLead, new Map&lt;String,Campaign&gt;(),attendeeWrappers);</b>
<i>150</i>&nbsp;
<b class="fc"><i>151</i>&nbsp;            TriggerHandler.bypass(&#39;StandardLeadTriggerHandler&#39;);</b>
<b class="fc"><i>152</i>&nbsp;            insert newLeads;</b>
<i>153</i>&nbsp;
<b class="fc"><i>154</i>&nbsp;            TriggerHandler.bypass(&#39;AttendeeTempTriggerHandler&#39;);</b>
<b class="fc"><i>155</i>&nbsp;            CventManagement.updateTempStatus(newTempsConvertedToLeads);</b>
<i>156</i>&nbsp;
<b class="fc"><i>157</i>&nbsp;            result.result = unmatchedTempAttendees.size() + &#39; Leads created for unmatched Temps and matchedTempAttendees size=&#39; + matchedTempAttendees.size();</b>
<b class="fc"><i>158</i>&nbsp;            result.attendeeWrappers = attendeeWrappers;</b>
<i>159</i>&nbsp;
<i>160</i>&nbsp;        }
<i>161</i>&nbsp;        catch (Exception e)
<b class="nc"><i>162</i>&nbsp;        {</b>
<b class="nc"><i>163</i>&nbsp;            Database.SaveResult savingErrorLogResult = DebugLog.addException(e, &#39;quickCreateCampaignFromCventController.convertTempAttendeesToLeads&#39;);</b>
<b class="nc"><i>164</i>&nbsp;            result.error = e;</b>
<b class="nc"><i>165</i>&nbsp;            if(savingErrorLogResult.isSuccess())</b>
<i>166</i>&nbsp;            {
<b class="nc"><i>167</i>&nbsp;                result.errorDebugLogId = savingErrorLogResult.getId();</b>
<i>168</i>&nbsp;            }
<i>169</i>&nbsp;        }
<i>170</i>&nbsp;
<b class="fc"><i>171</i>&nbsp;        return result;</b>
<i>172</i>&nbsp;    }
<i>173</i>&nbsp;
<i>174</i>&nbsp;    /** STAGE 3
<i>175</i>&nbsp;     * Root method that creates attendees
<i>176</i>&nbsp;     * For leads we create new attendees. And for matched temps to contacts, we re-create their existing attendees to trigger members generation by the app.
<i>177</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>178</i>&nbsp;     *
<i>179</i>&nbsp;     * @param attendeeWrappers Wrappers of attendees
<i>180</i>&nbsp;     *
<i>181</i>&nbsp;     * @return ResultWrapper - Controller Result Wrapper
<i>182</i>&nbsp;     */
<i>183</i>&nbsp;    @AuraEnabled
<b class="fc"><i>184</i>&nbsp;    public static ResultWrapper createNewAttendeesFromLeads(List&lt;AttendeeWrapper&gt; attendeeWrappers)</b>
<i>185</i>&nbsp;    {
<b class="fc"><i>186</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<b class="fc"><i>187</i>&nbsp;        List&lt;CventEvents__Attendee__c&gt; newAttendees = new List&lt;CventEvents__Attendee__c&gt;();</b>
<i>188</i>&nbsp;
<b class="fc"><i>189</i>&nbsp;        List&lt;CventEvents__Attendee__c&gt; attendeesToReCreateInLaterStage = new List&lt;CventEvents__Attendee__c&gt;();</b>
<i>190</i>&nbsp;
<b class="fc"><i>191</i>&nbsp;        CventManagement.partitionAndProcessWrapper(attendeeWrappers, attendeesToReCreateInLaterStage, newAttendees);</b>
<i>192</i>&nbsp;
<b class="fc"><i>193</i>&nbsp;        TriggerHandler.bypass(&#39;AttendeeTriggerHandler&#39;);</b>
<b class="fc"><i>194</i>&nbsp;        insertAttendees(newAttendees);</b>
<i>195</i>&nbsp;
<b class="fc"><i>196</i>&nbsp;        result.status = &#39;Success&#39;;</b>
<b class="fc"><i>197</i>&nbsp;        result.result = &#39;Success&#39;;</b>
<i>198</i>&nbsp;
<b class="fc"><i>199</i>&nbsp;        deleteExistingAttendees(attendeesToReCreateInLaterStage);</b>
<i>200</i>&nbsp;
<b class="fc"><i>201</i>&nbsp;        return result;</b>
<i>202</i>&nbsp;    }
<i>203</i>&nbsp;
<i>204</i>&nbsp;    /**
<i>205</i>&nbsp;     * Loop through the matchedAttendees List and create wrappers.
<i>206</i>&nbsp;     * The wrappers we will be used in a follow stage to recreate the records
<i>207</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>208</i>&nbsp;     *
<i>209</i>&nbsp;     * @param sourceCvent               Event
<i>210</i>&nbsp;     * @param matchedAttendees          The Matched Attendees records
<i>211</i>&nbsp;     * @param matchedTempAttendees      The Matched Attendees Temps records
<i>212</i>&nbsp;     *
<i>213</i>&nbsp;     * @return List&lt;AttendeeWrapper&gt; - Wrappers
<i>214</i>&nbsp;     */
<b class="fc"><i>215</i>&nbsp;    public static List&lt;AttendeeWrapper&gt; prepareMatchedAttendeesForReCreation(   List&lt;CventEvents__Event__c&gt; sourceCvent,</b>
<i>216</i>&nbsp;                                                                                Map&lt;String,CventEvents__Attendee__c&gt;        matchedAttendees,
<i>217</i>&nbsp;                                                                                Map&lt;String,CventEvents__AttendeeTemp__c&gt;    matchedTempAttendees)
<i>218</i>&nbsp;    {
<b class="fc"><i>219</i>&nbsp;        List&lt;AttendeeWrapper&gt; attendeeWrappers = new List&lt;AttendeeWrapper&gt;();</b>
<b class="fc"><i>220</i>&nbsp;        CventEvents__Attendee__c attendee;</b>
<b class="fc"><i>221</i>&nbsp;        CventEvents__AttendeeTemp__c temp;</b>
<i>222</i>&nbsp;
<b class="fc"><i>223</i>&nbsp;        for (Integer i = 0, j = matchedAttendees.values().size(); i &lt; j; i++) {</b>
<b class="fc"><i>224</i>&nbsp;            attendee = matchedAttendees.values()[i];</b>
<b class="fc"><i>225</i>&nbsp;            temp = matchedTempAttendees.get(attendee.CventEvents__AttendeeStub__c);</b>
<b class="fc"><i>226</i>&nbsp;            attendee.ContactType__c                 = temp.CventEvents__pkg_ContactTypeName__c;</b>
<b class="fc"><i>227</i>&nbsp;            attendee.IntraoralScannerInUse__c       = temp.Doyouhaveanintraoralscannerinyour__c;</b>
<b class="fc"><i>228</i>&nbsp;            attendee.SolutionsInterest__c           = temp.Whichsolutionsareyouinterestedin__c;</b>
<i>229</i>&nbsp;
<b class="fc"><i>230</i>&nbsp;            AttendeeWrapper attendeeWrapper = new AttendeeWrapper();</b>
<b class="fc"><i>231</i>&nbsp;            attendeeWrapper.matched = true;</b>
<b class="fc"><i>232</i>&nbsp;            attendeeWrapper.attendee = attendee;</b>
<b class="fc"><i>233</i>&nbsp;            attendeeWrapper.event = sourceCvent[0];</b>
<i>234</i>&nbsp;
<b class="fc"><i>235</i>&nbsp;            attendeeWrappers.add(attendeeWrapper);</b>
<i>236</i>&nbsp;        }
<b class="fc"><i>237</i>&nbsp;        return attendeeWrappers;</b>
<i>238</i>&nbsp;    }
<i>239</i>&nbsp;
<i>240</i>&nbsp;    /**
<i>241</i>&nbsp;     * Partition the list of attendees in two categories: Matched and unmatched
<i>242</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>243</i>&nbsp;     *
<i>244</i>&nbsp;     * @param allTemps                  all Attendees Temp records
<i>245</i>&nbsp;     * @param existingAttendeesStubs    Existing Attendees list
<i>246</i>&nbsp;     * @param matchedTempAttendees      Matched attendees to populate
<i>247</i>&nbsp;     * @param unmatchedAttendees        Unmatched Attendees to populate
<i>248</i>&nbsp;     */
<b class="fc"><i>249</i>&nbsp;    public static void partitionTemps(  Map&lt;String,CventEvents__AttendeeTemp__c&gt;    allTemps,</b>
<i>250</i>&nbsp;                                        Set&lt;String&gt;                                 existingAttendeesStubs,
<i>251</i>&nbsp;                                        Map&lt;String,CventEvents__AttendeeTemp__c&gt;    matchedTempAttendees,
<i>252</i>&nbsp;                                        Map&lt;Id,CventEvents__AttendeeTemp__c&gt;        unmatchedTempAttendees)
<i>253</i>&nbsp;    {
<b class="fc"><i>254</i>&nbsp;        CventEvents__AttendeeTemp__c temp;</b>
<b class="fc"><i>255</i>&nbsp;        for (Integer i = 0, j = allTemps.values().size(); i &lt; j; i++) {</b>
<b class="fc"><i>256</i>&nbsp;            temp = allTemps.values()[i];</b>
<b class="fc"><i>257</i>&nbsp;            if (existingAttendeesStubs.contains(temp.CventEvents__pkg_AttendeeStub__c)) {</b>
<b class="fc"><i>258</i>&nbsp;                matchedTempAttendees.put(temp.CventEvents__pkg_AttendeeStub__c,temp);</b>
<i>259</i>&nbsp;            }
<i>260</i>&nbsp;            else {
<b class="fc"><i>261</i>&nbsp;                unmatchedTempAttendees.put(temp.Id,temp);</b>
<i>262</i>&nbsp;            }
<i>263</i>&nbsp;        }
<i>264</i>&nbsp;    }
<i>265</i>&nbsp;
<i>266</i>&nbsp;    /**
<i>267</i>&nbsp;     * Retrieves all the existing Attendee Temp record for a particular event
<i>268</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>269</i>&nbsp;     *
<i>270</i>&nbsp;     * @param sourceCvent   Event
<i>271</i>&nbsp;     * @param mappings      Fields mapping to know what fields to retrieve
<i>272</i>&nbsp;     *
<i>273</i>&nbsp;     * @return List&lt;CventEvents__AttendeeTemp__c&gt; - List of Temp records
<i>274</i>&nbsp;     */
<b class="fc"><i>275</i>&nbsp;    public static Map&lt;String,CventEvents__AttendeeTemp__c&gt; getAllTemps(List&lt;CventEvents__Event__c&gt; sourceCvent, List&lt;DynamicMapping__mdt&gt; mappings )</b>
<i>276</i>&nbsp;    {
<b class="fc"><i>277</i>&nbsp;        List&lt;CventEvents__AttendeeTemp__c&gt; allTemps = new List&lt;CventEvents__AttendeeTemp__c&gt;();</b>
<b class="fc"><i>278</i>&nbsp;        Map&lt;String,CventEvents__AttendeeTemp__c&gt; allTempsMap = new Map&lt;String,CventEvents__AttendeeTemp__c&gt;();</b>
<b class="fc"><i>279</i>&nbsp;        String eventStub = sourceCvent[0].CventEvents__pkg_EventStub__c;</b>
<i>280</i>&nbsp;
<b class="fc"><i>281</i>&nbsp;        Set&lt;String&gt; allFields = new Set&lt;String&gt;{&#39;CventEvents__pkg_AttendeeStub__c&#39;, &#39;CventEvents__pkg_AttendeeStatus__c&#39;,</b>
<b class="fc"><i>282</i>&nbsp;                &#39;CventEvents__pkg_Attended__c&#39;, &#39;MatchStatus__c&#39;, &#39;Doyouhaveanintraoralscannerinyour__c&#39;,&#39;CventEvents__pkg_ContactTypeName__c&#39;,</b>
<b class="fc"><i>283</i>&nbsp;                &#39;Whichsolutionsareyouinterestedin__c&#39;}; // (+Static Cvent Fields.)</b>
<b class="fc"><i>284</i>&nbsp;        DynamicMapping__mdt mapping;</b>
<b class="fc"><i>285</i>&nbsp;        for (Integer i = 0, j = mappings.size(); i &lt; j; i++) {</b>
<b class="fc"><i>286</i>&nbsp;            mapping = mappings[i];</b>
<b class="fc"><i>287</i>&nbsp;            allFields.add(mapping.SourceFieldApiName__c);</b>
<i>288</i>&nbsp;        }
<i>289</i>&nbsp;
<b class="fc"><i>290</i>&nbsp;        String fieldsApiNames = String.join( new List&lt;String&gt;(allFields) , &#39;,&#39;);</b>
<b class="fc"><i>291</i>&nbsp;        String queryString = &#39;SELECT &#39; + fieldsApiNames + &#39; FROM &#39; + CventManagement.SOURCE_OBJECT_TEMP +</b>
<b class="fc"><i>292</i>&nbsp;                &#39; WHERE CventEvents__pkg_EventStub__c = :eventStub&#39;;</b>
<i>293</i>&nbsp;
<i>294</i>&nbsp;        // Execute Query
<b class="fc"><i>295</i>&nbsp;        allTemps  = Database.query(queryString);</b>
<i>296</i>&nbsp;
<b class="fc"><i>297</i>&nbsp;        for(CventEvents__AttendeeTemp__c temp : allTemps)</b>
<b class="fc"><i>298</i>&nbsp;        {</b>
<b class="fc"><i>299</i>&nbsp;            allTempsMap.put(temp.CventEvents__pkg_AttendeeStub__c,temp);</b>
<i>300</i>&nbsp;        }
<i>301</i>&nbsp;
<b class="fc"><i>302</i>&nbsp;        return allTempsMap;</b>
<i>303</i>&nbsp;    }
<i>304</i>&nbsp;
<i>305</i>&nbsp;    /**
<i>306</i>&nbsp;     * Deletes Attendees
<i>307</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>308</i>&nbsp;     *
<i>309</i>&nbsp;     * @param attendeesToReCreateInLaterStage Attendees to delete
<i>310</i>&nbsp;     */
<b class="fc"><i>311</i>&nbsp;    public static void deleteExistingAttendees(List&lt;CventEvents__Attendee__c&gt; attendeesToReCreateInLaterStage)</b>
<i>312</i>&nbsp;    {
<b class="fc"><i>313</i>&nbsp;        if (!attendeesToReCreateInLaterStage.isEmpty())</b>
<i>314</i>&nbsp;        {
<b class="fc"><i>315</i>&nbsp;            try {</b>
<b class="fc"><i>316</i>&nbsp;                delete attendeesToReCreateInLaterStage;</b>
<i>317</i>&nbsp;            }
<b class="nc"><i>318</i>&nbsp;            catch (Exception e) {</b>
<b class="nc"><i>319</i>&nbsp;                DebugLog.addException(e, &#39;quickCreateCampaignFromCventController.attendeesToReCreateInLaterStage&#39;);</b>
<i>320</i>&nbsp;            }
<i>321</i>&nbsp;        }
<i>322</i>&nbsp;    }
<i>323</i>&nbsp;
<i>324</i>&nbsp;    /**
<i>325</i>&nbsp;     * Insert Attendees in database
<i>326</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>327</i>&nbsp;     *
<i>328</i>&nbsp;     * @param newAttendees New Attendees to insert
<i>329</i>&nbsp;     */
<b class="fc"><i>330</i>&nbsp;    public static void insertAttendees(List&lt;CventEvents__Attendee__c&gt; newAttendees)</b>
<i>331</i>&nbsp;    {
<b class="fc"><i>332</i>&nbsp;        if (!newAttendees.isEmpty())</b>
<i>333</i>&nbsp;        {
<b class="fc"><i>334</i>&nbsp;            try {</b>
<b class="fc"><i>335</i>&nbsp;                insert newAttendees;</b>
<i>336</i>&nbsp;            }
<b class="nc"><i>337</i>&nbsp;            catch (Exception e) {</b>
<b class="nc"><i>338</i>&nbsp;                DebugLog.addException(e, &#39;quickCreateCampaignFromCventController.insert new attendees&#39;);</b>
<i>339</i>&nbsp;            }
<i>340</i>&nbsp;        }
<i>341</i>&nbsp;    }
<i>342</i>&nbsp;
<i>343</i>&nbsp;    /**
<i>344</i>&nbsp;     * Check if the event is already linked to another campaign via CventEvents__EventCampaignEntry__c entries
<i>345</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>346</i>&nbsp;     *
<i>347</i>&nbsp;     * @param sourceEvent Source Event
<i>348</i>&nbsp;     *
<i>349</i>&nbsp;     * @return Boolean - Whether or not the event is linked to another campaign record.
<i>350</i>&nbsp;     */
<b class="fc"><i>351</i>&nbsp;    private static Boolean alreadyLinkedToACampaign(CventEvents__Event__c sourceEvent)</b>
<i>352</i>&nbsp;    {
<b class="fc"><i>353</i>&nbsp;        Boolean alreadyLinked = false;</b>
<b class="fc"><i>354</i>&nbsp;        CventEvents__EventCampaignEntry__c[] entries = [SELECT Id,CventEvents__Campaign__c</b>
<i>355</i>&nbsp;        FROM CventEvents__EventCampaignEntry__c
<b class="fc"><i>356</i>&nbsp;        WHERE CventEvents__Event__c = :sourceEvent.Id LIMIT 1];</b>
<b class="fc"><i>357</i>&nbsp;        if(!entries.isEmpty())</b>
<i>358</i>&nbsp;        {
<b class="fc"><i>359</i>&nbsp;            linkedCampaign = entries[0].CventEvents__Campaign__c;</b>
<b class="fc"><i>360</i>&nbsp;            alreadyLinked = true;</b>
<i>361</i>&nbsp;        }
<i>362</i>&nbsp;
<b class="fc"><i>363</i>&nbsp;        return alreadyLinked;</b>
<i>364</i>&nbsp;    }
<i>365</i>&nbsp;
<i>366</i>&nbsp;    /**
<i>367</i>&nbsp;     * The user has Wants to creates a campaign for Cvent Event record that has already a campaign created previously
<i>368</i>&nbsp;     * Returns an error
<i>369</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>370</i>&nbsp;     *
<i>371</i>&nbsp;     * @param existingCampaign  Existing Campaign Id
<i>372</i>&nbsp;     * @param cventCode         Cvent Code Entered by the user
<i>373</i>&nbsp;     *
<i>374</i>&nbsp;     * @return ResultWrapper - Stating that this Cvent entered has already a linked Campaign
<i>375</i>&nbsp;     */
<b class="fc"><i>376</i>&nbsp;    private static ResultWrapper errorAlreadyLinkedToACampaign(Id existingCampaign, String cventCode)</b>
<i>377</i>&nbsp;    {
<b class="fc"><i>378</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<b class="fc"><i>379</i>&nbsp;        result.result   = existingCampaign;</b>
<b class="fc"><i>380</i>&nbsp;        result.error    = &#39;Found an existing campaign linked this event (Code:&#39; + cventCode + &#39;)&#39;;</b>
<b class="fc"><i>381</i>&nbsp;        result.status   = &#39;Existing&#39;;</b>
<i>382</i>&nbsp;
<b class="fc"><i>383</i>&nbsp;        return result;</b>
<i>384</i>&nbsp;    }
<i>385</i>&nbsp;
<i>386</i>&nbsp;    /**
<i>387</i>&nbsp;     * No Cvent is found with this code entered by the user.
<i>388</i>&nbsp;     * Returns an error
<i>389</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>390</i>&nbsp;     *
<i>391</i>&nbsp;     * @param cventCode     Code Entered by the user
<i>392</i>&nbsp;     *
<i>393</i>&nbsp;     * @return ResultWrapper - Stating that no Cvent is found with this code entered
<i>394</i>&nbsp;     */
<b class="fc"><i>395</i>&nbsp;    private static ResultWrapper errorCodeNotFound(String cventCode)</b>
<i>396</i>&nbsp;    {
<b class="fc"><i>397</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<b class="fc"><i>398</i>&nbsp;        result.error    = &#39;We couldn\&#39;t find any record with the entered code (&#39; + cventCode + &#39;). &#39; +</b>
<i>399</i>&nbsp;                &#39;Please enter a valid code.&#39;;
<b class="fc"><i>400</i>&nbsp;        result.status   = &#39;Not Found&#39;;</b>
<b class="fc"><i>401</i>&nbsp;        return result;</b>
<i>402</i>&nbsp;    }
<i>403</i>&nbsp;
<i>404</i>&nbsp;    /**
<i>405</i>&nbsp;     * Will try to create the Campaign using the existing Mapping in the custom metadata records
<i>406</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>407</i>&nbsp;     *
<i>408</i>&nbsp;     * @param sourceEvent     Cvent Event Code entered by the User
<i>409</i>&nbsp;     * @param mainBrand       Main Brand of the campaign
<i>410</i>&nbsp;     * @param convertMembersToSalesLeads       Set Campaign Convert To = &#39;Sales Lead&#39;
<i>411</i>&nbsp;     *
<i>412</i>&nbsp;     * @return ResultWrapper - Result
<i>413</i>&nbsp;     */
<b class="fc"><i>414</i>&nbsp;    private static ResultWrapper startCreationProcess(CventEvents__Event__c sourceEvent, String mainBrand, Boolean convertMembersToSalesLeads)</b>
<i>415</i>&nbsp;    {
<b class="fc"><i>416</i>&nbsp;        ResultWrapper result = new ResultWrapper();</b>
<i>417</i>&nbsp;        // Step 1 - Get Mappings from Custom Metadata DynamicMapping__mdt
<b class="fc"><i>418</i>&nbsp;        List&lt;DynamicMapping__mdt&gt; mappings =</b>
<b class="fc"><i>419</i>&nbsp;                MappingManagement.getMapping(CventManagement.SOURCE_OBJECT_EVENT, CventManagement.TARGET_OBJECT_CAMPAIGN,true);</b>
<i>420</i>&nbsp;
<b class="fc"><i>421</i>&nbsp;        if (mappings.size() &gt; 0)</b>
<i>422</i>&nbsp;        {
<b class="fc"><i>423</i>&nbsp;            SObject sourceRecordData;</b>
<i>424</i>&nbsp;            // Step 2 - If mapping records are found, we retrieve the data to use to create the target object record
<b class="fc"><i>425</i>&nbsp;            try</b>
<i>426</i>&nbsp;            {
<b class="fc"><i>427</i>&nbsp;                sourceRecordData = MappingManagement.retrieveSourceData(</b>
<b class="fc"><i>428</i>&nbsp;                        sourceEvent.Id,</b>
<b class="fc"><i>429</i>&nbsp;                        CventManagement.SOURCE_OBJECT_EVENT,</b>
<b class="fc"><i>430</i>&nbsp;                        mappings,</b>
<b class="fc"><i>431</i>&nbsp;                        new Set&lt;String&gt;{&#39;CventEvents__pkg_CountryCode__c,CventEvents__pkg_EventStub__c,TotalEstimatedBudget__c&#39;});</b>
<i>432</i>&nbsp;            }
<i>433</i>&nbsp;            catch (Exception e)
<b class="nc"><i>434</i>&nbsp;            {</b>
<b class="nc"><i>435</i>&nbsp;                Database.SaveResult savingErrorLogResult = DebugLog.addException(e,&#39;MappingManagement.retrieveSourceData&#39;);</b>
<b class="nc"><i>436</i>&nbsp;                result.error = &#39;Error while trying to retrieve Event data. Please contact your system administrator for assistance.&#39;;</b>
<b class="nc"><i>437</i>&nbsp;                MappingManagement.attemptToFixWrongMapping(e.getMessage());</b>
<b class="nc"><i>438</i>&nbsp;                if(savingErrorLogResult.isSuccess())</b>
<i>439</i>&nbsp;                {
<b class="nc"><i>440</i>&nbsp;                    result.errorDebugLogId = savingErrorLogResult.getId();</b>
<i>441</i>&nbsp;                }
<b class="nc"><i>442</i>&nbsp;                return result;</b>
<i>443</i>&nbsp;            }
<i>444</i>&nbsp;
<i>445</i>&nbsp;            // Step 3 - Insert Campaign record
<b class="fc"><i>446</i>&nbsp;            Id campaignId = createCampaign(mappings, sourceRecordData, mainBrand, convertMembersToSalesLeads);</b>
<b class="fc"><i>447</i>&nbsp;            if(campaignId != null)</b>
<i>448</i>&nbsp;            {
<b class="fc"><i>449</i>&nbsp;                result.result = (String) campaignId;</b>
<i>450</i>&nbsp;
<i>451</i>&nbsp;                // Step 4 - Link the Cvent Event with the new created Campaign
<b class="fc"><i>452</i>&nbsp;                CventManagement.linkCampaignWithEvent(sourceEvent.Id,campaignId);</b>
<i>453</i>&nbsp;            }
<i>454</i>&nbsp;            else
<i>455</i>&nbsp;            {
<b class="nc"><i>456</i>&nbsp;                result.error = &#39;Error while trying to create the campaign record. Please contact your system administrator for assistance.&#39;;</b>
<i>457</i>&nbsp;            }
<i>458</i>&nbsp;        }
<i>459</i>&nbsp;        else
<i>460</i>&nbsp;        {
<b class="nc"><i>461</i>&nbsp;            result.error = &#39;No Valid Mappings found for Campaign Creation&#39;;</b>
<i>462</i>&nbsp;        }
<i>463</i>&nbsp;
<b class="fc"><i>464</i>&nbsp;        return result;</b>
<i>465</i>&nbsp;    }
<i>466</i>&nbsp;
<i>467</i>&nbsp;    /**
<i>468</i>&nbsp;     * Creates a campaign records using mapping values
<i>469</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>470</i>&nbsp;     *
<i>471</i>&nbsp;     * @param mappings              Existing mappings in DynamicMapping__mdt records
<i>472</i>&nbsp;     * @param retrievedSourceData   The Cvent Data we will use to create the Campaign
<i>473</i>&nbsp;     * @param mainBrand             Campaign main brand
<i>474</i>&nbsp;     * @param convertMembersToSalesLeads    Set Campaign Convert To = &#39;Sales Lead&#39;
<i>475</i>&nbsp;     *
<i>476</i>&nbsp;     * @return Id - Id of the campaign created
<i>477</i>&nbsp;     */
<b class="fc"><i>478</i>&nbsp;    private static Id createCampaign(List&lt;DynamicMapping__mdt&gt; mappings, SObject retrievedSourceData, String mainBrand, Boolean convertMembersToSalesLeads)</b>
<i>479</i>&nbsp;    {
<b class="fc"><i>480</i>&nbsp;        if(retrievedSourceData == null) return null;</b>
<b class="fc"><i>481</i>&nbsp;        if(mappings.isEmpty()) return null;</b>
<i>482</i>&nbsp;
<b class="fc"><i>483</i>&nbsp;        Id campaignRecordTypeId = GlobalUtils.getRecordTypeId(&#39;Campaign&#39;, &#39;CventCampaign&#39;);</b>
<b class="fc"><i>484</i>&nbsp;        Id memberRecordTypeId   = GlobalUtils.getRecordTypeId(&#39;CampaignMember&#39;, &#39;CVENT_Campaign_Member&#39;);</b>
<b class="fc"><i>485</i>&nbsp;        Campaign campaign = new Campaign(</b>
<b class="fc"><i>486</i>&nbsp;                IsActive = true,</b>
<b class="fc"><i>487</i>&nbsp;                SBU_Focus__c = &#39;Implants&#39;,</b>
<b class="fc"><i>488</i>&nbsp;                Brands__c = mainBrand);</b>
<i>489</i>&nbsp;
<b class="fc"><i>490</i>&nbsp;        if(convertMembersToSalesLeads) {</b>
<b class="nc"><i>491</i>&nbsp;            campaign.Convert_To__c = &#39;Sales Lead&#39;;</b>
<i>492</i>&nbsp;        }
<i>493</i>&nbsp;
<b class="fc"><i>494</i>&nbsp;        setTotalCostBudget(retrievedSourceData, campaign);</b>
<b class="fc"><i>495</i>&nbsp;        setCampaignCountry(retrievedSourceData, campaign);</b>
<i>496</i>&nbsp;
<b class="fc"><i>497</i>&nbsp;        if(campaignRecordTypeId != null)</b>
<i>498</i>&nbsp;        {
<b class="fc"><i>499</i>&nbsp;            campaign.RecordTypeId = campaignRecordTypeId;</b>
<i>500</i>&nbsp;        }
<b class="fc"><i>501</i>&nbsp;        if(memberRecordTypeId != null)</b>
<i>502</i>&nbsp;        {
<b class="fc"><i>503</i>&nbsp;            campaign.CampaignMemberRecordTypeId = memberRecordTypeId;</b>
<i>504</i>&nbsp;        }
<i>505</i>&nbsp;
<i>506</i>&nbsp;        // For each mapping, we will use the data retrieved in the SObject record
<i>507</i>&nbsp;        // to put the value dynamically using &lt;record&gt;.put(&lt;field&gt;,&lt;value&gt;) method
<b class="fc"><i>508</i>&nbsp;        for (DynamicMapping__mdt mapping : mappings)</b>
<b class="fc"><i>509</i>&nbsp;        {</b>
<b class="fc"><i>510</i>&nbsp;            try</b>
<i>511</i>&nbsp;            {
<b class="fc"><i>512</i>&nbsp;                if (mapping.limitStringLength__c != null) {</b>
<i>513</i>&nbsp;                    // Special Case for limited strings
<i>514</i>&nbsp;                    // The field limitStringLength__c Field on the custom metadata allow the admins to
<i>515</i>&nbsp;                    // limit the number of chars in the source value to no exceed target field max length
<b class="fc"><i>516</i>&nbsp;                    String sourceValue = (String) retrievedSourceData.get(mapping.SourceFieldApiName__c);</b>
<b class="fc"><i>517</i>&nbsp;                    if(sourceValue != null)</b>
<i>518</i>&nbsp;                    {
<b class="fc"><i>519</i>&nbsp;                        sourceValue = sourceValue.left(mapping.limitStringLength__c.intValue());</b>
<b class="fc"><i>520</i>&nbsp;                        campaign.put(mapping.TargetFieldApiName__c, sourceValue);</b>
<i>521</i>&nbsp;                    }
<i>522</i>&nbsp;                }
<i>523</i>&nbsp;                else {
<i>524</i>&nbsp;                    // Default: We just put the value in the field
<b class="fc"><i>525</i>&nbsp;                    Object targetValue = retrievedSourceData.get(mapping.SourceFieldApiName__c);</b>
<b class="fc"><i>526</i>&nbsp;                    campaign.put(mapping.TargetFieldApiName__c, targetValue);</b>
<i>527</i>&nbsp;                }
<i>528</i>&nbsp;            }
<i>529</i>&nbsp;            catch (Exception e)
<b class="nc"><i>530</i>&nbsp;            {</b>
<b class="nc"><i>531</i>&nbsp;                DebugLog.addException(e,&#39;quickCreateCampaignFromCventController.createCampaign. Failed mapping: &#39; + JSON.serializePretty(mapping));</b>
<b class="nc"><i>532</i>&nbsp;                MappingManagement.tickMappingAsInvalid(mapping.QualifiedApiName,e.getMessage());</b>
<i>533</i>&nbsp;            }
<i>534</i>&nbsp;        }
<i>535</i>&nbsp;
<b class="fc"><i>536</i>&nbsp;        return insertCampaignAndHandleErrors(campaign);</b>
<i>537</i>&nbsp;    }
<i>538</i>&nbsp;
<i>539</i>&nbsp;    /**
<i>540</i>&nbsp;     * Sets the country of the campaign using the country code of the event record and CountryCodeMap__mdt custom mdt
<i>541</i>&nbsp;     * @author hadib@salesforce.com | 02-08-2023
<i>542</i>&nbsp;     *
<i>543</i>&nbsp;     * @param retrievedSourceData Event Data
<i>544</i>&nbsp;     * @param campaign The new Campaign record
<i>545</i>&nbsp;     */
<b class="fc"><i>546</i>&nbsp;    private static void setCampaignCountry(SObject retrievedSourceData, Campaign campaign)</b>
<i>547</i>&nbsp;    {
<b class="fc"><i>548</i>&nbsp;        String countryCode;</b>
<b class="fc"><i>549</i>&nbsp;        if(retrievedSourceData != null)</b>
<i>550</i>&nbsp;        {
<b class="fc"><i>551</i>&nbsp;            countryCode = (String) retrievedSourceData.get(&#39;CventEvents__pkg_CountryCode__c&#39;);</b>
<i>552</i>&nbsp;        }
<i>553</i>&nbsp;
<b class="fc"><i>554</i>&nbsp;        if (String.isNotBlank(countryCode)) {</b>
<b class="nc"><i>555</i>&nbsp;            List&lt;CountryCodeMap__mdt&gt; country = [</b>
<i>556</i>&nbsp;                    SELECT Campaign_Country__c, Country_Code_3_digit__c
<i>557</i>&nbsp;                    FROM CountryCodeMap__mdt
<b class="nc"><i>558</i>&nbsp;                    WHERE Country_Code_2_digit__c = :countryCode</b>
<i>559</i>&nbsp;            ];
<b class="nc"><i>560</i>&nbsp;            if (!country.isEmpty()) {</b>
<b class="nc"><i>561</i>&nbsp;                campaign.Country_Code_3_digit__c = country[0].Country_Code_3_digit__c;</b>
<i>562</i>&nbsp;            }
<i>563</i>&nbsp;        }
<i>564</i>&nbsp;    }
<i>565</i>&nbsp;
<i>566</i>&nbsp;    /**
<i>567</i>&nbsp;     * Sets the total cost budget on the campaign by converting a string value on the event TotalEstimatedBudget__c field
<i>568</i>&nbsp;     * @author hadib@salesforce.com | 31-10-2023
<i>569</i>&nbsp;     *
<i>570</i>&nbsp;     * @param retrievedSourceData Event Data
<i>571</i>&nbsp;     * @param campaign The new Campaign record
<i>572</i>&nbsp;     */
<b class="fc"><i>573</i>&nbsp;    private static void setTotalCostBudget(SObject retrievedSourceData, Campaign campaign)</b>
<i>574</i>&nbsp;    {
<b class="fc"><i>575</i>&nbsp;        String totalEstimatedStringValue;</b>
<i>576</i>&nbsp;
<b class="fc"><i>577</i>&nbsp;        if (retrievedSourceData != null) {</b>
<b class="fc"><i>578</i>&nbsp;            totalEstimatedStringValue = (String) retrievedSourceData.get(&#39;TotalEstimatedBudget__c&#39;);</b>
<i>579</i>&nbsp;        }
<i>580</i>&nbsp;
<b class="fc"><i>581</i>&nbsp;        try {</b>
<b class="fc"><i>582</i>&nbsp;            Decimal totalEstimatedBudget = Decimal.valueOf(totalEstimatedStringValue);</b>
<b class="nc"><i>583</i>&nbsp;            campaign.TotalCostBudgetCvent__c = totalEstimatedBudget;</b>
<b class="fc"><i>584</i>&nbsp;        } catch (Exception ex) {</b>
<i>585</i>&nbsp;            // Ignoring error, leaving the campaign field as null
<b class="fc"><i>586</i>&nbsp;            campaign.TotalCostBudgetCvent__c = null;</b>
<i>587</i>&nbsp;        }
<i>588</i>&nbsp;    }
<i>589</i>&nbsp;
<i>590</i>&nbsp;
<i>591</i>&nbsp;    /**
<i>592</i>&nbsp;     * Inserts the campaign record and handle mappings errors
<i>593</i>&nbsp;     * @author hadib@salesforce.com | 20-03-2023
<i>594</i>&nbsp;     *
<i>595</i>&nbsp;     * @param campaign Campaign to insert
<i>596</i>&nbsp;     *
<i>597</i>&nbsp;     * @return Inserted Campaign Id
<i>598</i>&nbsp;     */
<b class="fc"><i>599</i>&nbsp;    private static Id insertCampaignAndHandleErrors(Campaign campaign)</b>
<i>600</i>&nbsp;    {
<b class="fc"><i>601</i>&nbsp;        Database.SaveResult saveResult;</b>
<b class="fc"><i>602</i>&nbsp;        try {</b>
<i>603</i>&nbsp;
<b class="fc"><i>604</i>&nbsp;            saveResult = Database.insert(campaign, true);</b>
<i>605</i>&nbsp;
<b class="fc"><i>606</i>&nbsp;            return campaign.Id;</b>
<i>607</i>&nbsp;        }
<i>608</i>&nbsp;        catch (DmlException e)
<b class="nc"><i>609</i>&nbsp;        {</b>
<b class="nc"><i>610</i>&nbsp;            if(!e.getDmlFieldNames(0).isEmpty())</b>
<i>611</i>&nbsp;            {
<b class="nc"><i>612</i>&nbsp;                MappingManagement.tickTargetFieldAsInvalid(e.getDmlFieldNames(0)[0], e.getMessage(), CventManagement.SOURCE_OBJECT_EVENT, CventManagement.TARGET_OBJECT_CAMPAIGN);</b>
<i>613</i>&nbsp;            }
<b class="nc"><i>614</i>&nbsp;            if (saveResult != null) {</b>
<b class="nc"><i>615</i>&nbsp;                if (!saveResult.isSuccess()) {</b>
<b class="nc"><i>616</i>&nbsp;                    for (Database.Error error : saveResult.getErrors()) {</b>
<i>617</i>&nbsp;                        // Log the failed field and error message
<b class="nc"><i>618</i>&nbsp;                        DebugLog.addInfo(&#39;quickCreateCampaignFromCventController.createCampaign. Failed field: &#39; + error.getFields() + &#39;, Error message: &#39; + error.getMessage());</b>
<i>619</i>&nbsp;                    }
<i>620</i>&nbsp;                }
<i>621</i>&nbsp;            }
<i>622</i>&nbsp;
<i>623</i>&nbsp;            // Log the exception using a custom logging method
<b class="nc"><i>624</i>&nbsp;            DebugLog.addException(e, &#39;quickCreateCampaignFromCventController.createCampaign&#39;);</b>
<i>625</i>&nbsp;        }
<b class="nc"><i>626</i>&nbsp;        return null;</b>
<i>627</i>&nbsp;    }
<i>628</i>&nbsp;
<i>629</i>&nbsp;    /**
<i>630</i>&nbsp;     * Get the number of matched and unmatched attendees that were converted to campaign members by the cvent application
<i>631</i>&nbsp;     * @author hadib@salesforce.com | 29-01-2024
<i>632</i>&nbsp;     * @param campaignId If of the New campaign generated
<i>633</i>&nbsp;     *
<i>634</i>&nbsp;     * @return Campaign - Campaign record with the information in the fields
<i>635</i>&nbsp;     */
<i>636</i>&nbsp;    @AuraEnabled
<b class="nc"><i>637</i>&nbsp;    public static Campaign getMembersCount(String campaignId)</b>
<i>638</i>&nbsp;    {
<b class="nc"><i>639</i>&nbsp;        try {</b>
<b class="nc"><i>640</i>&nbsp;            Campaign campaign;</b>
<b class="nc"><i>641</i>&nbsp;            List&lt;Campaign&gt; campaigns = [SELECT NumberOfContacts, NumberOfLeads FROM Campaign WHERE Id = :campaignId];</b>
<b class="nc"><i>642</i>&nbsp;            if (!campaigns.isEmpty()) {</b>
<b class="nc"><i>643</i>&nbsp;                campaign = campaigns[0];</b>
<i>644</i>&nbsp;            }
<b class="nc"><i>645</i>&nbsp;            return campaign;</b>
<i>646</i>&nbsp;        }
<b class="nc"><i>647</i>&nbsp;        catch (Exception e) {</b>
<b class="nc"><i>648</i>&nbsp;            NotificationEventPublisher.publishNotification( NotificationEventPublisher.EXCEPTION_CONTEXT,   NotificationEventPublisher.EXCEPTION_TYPE,</b>
<b class="nc"><i>649</i>&nbsp;                                                    &#39;Error&#39;,&#39;getMembersCount&#39;,       JSON.serializePretty(e));</b>
<b class="nc"><i>650</i>&nbsp;            throw new AuraHandledException(e.getMessage());</b>
<i>651</i>&nbsp;        }
<i>652</i>&nbsp;    }
<i>653</i>&nbsp;
<i>654</i>&nbsp;    /**
<i>655</i>&nbsp;     * The inner class will allow us to report errors in the database without throwing exceptions
<i>656</i>&nbsp;     * We can still inform the view with server errors with the wrapper instead of throwing exceptions
<i>657</i>&nbsp;     */
<i>658</i>&nbsp;    public class ResultWrapper
<i>659</i>&nbsp;    {
<i>660</i>&nbsp;        @AuraEnabled
<i>661</i>&nbsp;        public Object result;
<i>662</i>&nbsp;        @AuraEnabled
<i>663</i>&nbsp;        public Object error;
<i>664</i>&nbsp;        @AuraEnabled
<i>665</i>&nbsp;        public Object errorDebugLogId;
<i>666</i>&nbsp;        @AuraEnabled
<i>667</i>&nbsp;        public String status; // Success || Error || Existing || Not Found
<i>668</i>&nbsp;        @AuraEnabled
<i>669</i>&nbsp;        public List&lt;AttendeeWrapper&gt; attendeeWrappers; // Unmatched, have new leads generated
<i>670</i>&nbsp;
<i>671</i>&nbsp;    }
<i>672</i>&nbsp;
<i>673</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2024-12-10 16:19</div>
</div>
</body>
</html>
