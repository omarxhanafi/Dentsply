


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: StandardLeadTriggerHelper</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">default.classes</a> ]
</div>

<h1>Coverage Summary for Class: StandardLeadTriggerHelper (default.classes)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">StandardLeadTriggerHelper</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (60/ 80)
  </span>
</td>
</tr>

</table>

<br/>
<br/>

<h2>StandardLeadTriggerHelper</h2>
<div class="sourceCode"><i>1</i>&nbsp;global with sharing class StandardLeadTriggerHelper {
<i>2</i>&nbsp;    
<i>3</i>&nbsp;    private static final String SOBJECT_NAME = &#39;Lead&#39;;
<i>4</i>&nbsp;
<i>5</i>&nbsp;    /**
<i>6</i>&nbsp;     * Updates the &quot;Globally Shared&quot; checkbox on Campaigns linked to Leads.
<i>7</i>&nbsp;     *
<i>8</i>&nbsp;     * Finds all Campaigns linked to the provided Leads and checks if any Lead has a different Country from the Campaign.
<i>9</i>&nbsp;     * Marks the Campaign as &quot;Globally Shared&quot; if a difference is found.
<i>10</i>&nbsp;     * @author hadib@salesforce.com | 03-10-2024
<i>11</i>&nbsp;     * @param newLeads The new lead records
<i>12</i>&nbsp;     * @param oldLeads The old lead records
<i>13</i>&nbsp;     */
<b class="fc"><i>14</i>&nbsp;    public static void processLeads(Map&lt;Id, Lead&gt; newLeads, Map&lt;Id, Lead&gt; oldLeads)</b>
<i>15</i>&nbsp;    {
<b class="fc"><i>16</i>&nbsp;        Set&lt;Id&gt; campaignsToProcess = collectCampaignsToProcess(newLeads,oldLeads);</b>
<i>17</i>&nbsp;
<b class="fc"><i>18</i>&nbsp;        if (!campaignsToProcess.isEmpty()) {</b>
<i>19</i>&nbsp;            // Query all campaign members for the campaigns we need to process
<b class="fc"><i>20</i>&nbsp;            List&lt;CampaignMember&gt; membersForCampaigns = [</b>
<i>21</i>&nbsp;                    SELECT Id, CampaignId, Lead.Country, Campaign.Campaign_Country__c
<i>22</i>&nbsp;                    FROM CampaignMember
<b class="fc"><i>23</i>&nbsp;                    WHERE CampaignId IN :campaignsToProcess</b>
<i>24</i>&nbsp;            ];
<i>25</i>&nbsp;
<i>26</i>&nbsp;            // Map to track campaign processing
<b class="fc"><i>27</i>&nbsp;            Map&lt;Id, Boolean&gt; campaignToSharedGloballyMap = getCampaignToSharedGloballyMap(membersForCampaigns);</b>
<i>28</i>&nbsp;
<i>29</i>&nbsp;            // Now update the campaigns if needed
<b class="fc"><i>30</i>&nbsp;            List&lt;Campaign&gt; campaignsToUpdate = [SELECT Id, SharedGlobally__c FROM Campaign WHERE Id IN :campaignToSharedGloballyMap.keySet()];</b>
<b class="fc"><i>31</i>&nbsp;            for (Campaign camp : campaignsToUpdate) {</b>
<b class="fc"><i>32</i>&nbsp;                Boolean shouldBeShared = campaignToSharedGloballyMap.get(camp.Id);</b>
<b class="fc"><i>33</i>&nbsp;                if (camp.SharedGlobally__c != shouldBeShared) {</b>
<b class="fc"><i>34</i>&nbsp;                    camp.SharedGlobally__c = shouldBeShared;</b>
<i>35</i>&nbsp;                }
<i>36</i>&nbsp;            }
<i>37</i>&nbsp;
<b class="fc"><i>38</i>&nbsp;            if (!campaignsToUpdate.isEmpty()) {</b>
<b class="fc"><i>39</i>&nbsp;                try {</b>
<b class="fc"><i>40</i>&nbsp;                    update campaignsToUpdate;</b>
<b class="nc"><i>41</i>&nbsp;                } catch (Exception e) {</b>
<b class="nc"><i>42</i>&nbsp;                    DebugLog.addException(e, &#39;Error while updating Campaigns based on Lead country changes&#39;);</b>
<i>43</i>&nbsp;                }
<i>44</i>&nbsp;            }
<i>45</i>&nbsp;        }
<i>46</i>&nbsp;    }
<i>47</i>&nbsp;
<i>48</i>&nbsp;    /**
<i>49</i>&nbsp;     * Based on the campaign members countries we know if we need to shared it globally or not
<i>50</i>&nbsp;     * @author hadib@salesforce.com | 03-10-2024
<i>51</i>&nbsp;     * @param membersForCampaigns
<i>52</i>&nbsp;     *
<i>53</i>&nbsp;     * @return Map&lt;Id, Boolean&gt; - If the campaign should be shared or not
<i>54</i>&nbsp;     */
<b class="fc"><i>55</i>&nbsp;    public static Map&lt;Id, Boolean&gt; getCampaignToSharedGloballyMap(List&lt;CampaignMember&gt; membersForCampaigns)</b>
<i>56</i>&nbsp;    {
<b class="fc"><i>57</i>&nbsp;        Map&lt;Id, Boolean&gt; campaignToSharedGloballyMap = new Map&lt;Id, Boolean&gt;();</b>
<i>58</i>&nbsp;
<i>59</i>&nbsp;        // Group campaign members by campaignId
<b class="fc"><i>60</i>&nbsp;        Map&lt;Id, List&lt;CampaignMember&gt;&gt; campaignIdToMembersMap = new Map&lt;Id, List&lt;CampaignMember&gt;&gt;();</b>
<b class="fc"><i>61</i>&nbsp;        for (CampaignMember cm : membersForCampaigns) {</b>
<b class="fc"><i>62</i>&nbsp;            if (!campaignIdToMembersMap.containsKey(cm.CampaignId)) {</b>
<b class="fc"><i>63</i>&nbsp;                campaignIdToMembersMap.put(cm.CampaignId, new List&lt;CampaignMember&gt;());</b>
<i>64</i>&nbsp;            }
<b class="fc"><i>65</i>&nbsp;            campaignIdToMembersMap.get(cm.CampaignId).add(cm);</b>
<i>66</i>&nbsp;        }
<i>67</i>&nbsp;
<i>68</i>&nbsp;        // Process each campaign and check if any member has a different country
<b class="fc"><i>69</i>&nbsp;        for (Id campaignId : campaignIdToMembersMap.keySet()) {</b>
<b class="fc"><i>70</i>&nbsp;            List&lt;CampaignMember&gt; campaignMembers = campaignIdToMembersMap.get(campaignId);</b>
<b class="fc"><i>71</i>&nbsp;            Boolean globallyShared = false;</b>
<i>72</i>&nbsp;
<b class="fc"><i>73</i>&nbsp;            for (CampaignMember cm : campaignMembers) {</b>
<b class="fc"><i>74</i>&nbsp;                if (String.isNotBlank(cm.Lead.Country) &amp;&amp; cm.Lead.Country != cm.Campaign.Campaign_Country__c) {</b>
<b class="fc"><i>75</i>&nbsp;                    globallyShared = true;</b>
<b class="fc"><i>76</i>&nbsp;                    break; // No need to check further if one mismatch is found</b>
<i>77</i>&nbsp;                }
<i>78</i>&nbsp;            }
<i>79</i>&nbsp;
<b class="fc"><i>80</i>&nbsp;            campaignToSharedGloballyMap.put(campaignId, globallyShared);</b>
<i>81</i>&nbsp;        }
<b class="fc"><i>82</i>&nbsp;        return campaignToSharedGloballyMap;</b>
<i>83</i>&nbsp;    }
<i>84</i>&nbsp;
<i>85</i>&nbsp;    /**
<i>86</i>&nbsp;     * Collects the parent campaigns of the leads. For inserts, it collects all leads;
<i>87</i>&nbsp;     * for updates, it collects only those where the country field has changed.
<i>88</i>&nbsp;     * @author hadib@salesforce.com | 03-10-2024
<i>89</i>&nbsp;     * @param newLeads Map of new leads
<i>90</i>&nbsp;     * @param oldLeads Map of old leads
<i>91</i>&nbsp;     *
<i>92</i>&nbsp;     * @return Set&lt;Id&gt; - Set of campaign Ids to process
<i>93</i>&nbsp;     */
<b class="fc"><i>94</i>&nbsp;    public static Set&lt;Id&gt; collectCampaignsToProcess(Map&lt;Id, Lead&gt; newLeads, Map&lt;Id, Lead&gt; oldLeads) {</b>
<b class="fc"><i>95</i>&nbsp;        Set&lt;Id&gt; campaignsToProcess = new Set&lt;Id&gt;();</b>
<b class="fc"><i>96</i>&nbsp;        Set&lt;Id&gt; leadIdsToProcess = new Set&lt;Id&gt;();</b>
<b class="fc"><i>97</i>&nbsp;        Lead oldLead;</b>
<b class="fc"><i>98</i>&nbsp;        Lead newLead;</b>
<i>99</i>&nbsp;        // Loop through the new leads and check if we are in insert or update context
<b class="fc"><i>100</i>&nbsp;        for (Id leadId : newLeads.keySet())</b>
<b class="fc"><i>101</i>&nbsp;        {</b>
<b class="fc"><i>102</i>&nbsp;            newLead = newLeads.get(leadId);</b>
<i>103</i>&nbsp;
<i>104</i>&nbsp;            // If oldLead is null, it&#39;s an insert, so add the lead to process
<b class="fc"><i>105</i>&nbsp;            if (oldLeads == null) {</b>
<b class="fc"><i>106</i>&nbsp;                leadIdsToProcess.add(leadId);</b>
<i>107</i>&nbsp;            }
<i>108</i>&nbsp;            // If oldLead is not null (update), check if the Country field has changed
<i>109</i>&nbsp;            else {
<b class="fc"><i>110</i>&nbsp;                oldLead = oldLeads.get(leadId);</b>
<b class="fc"><i>111</i>&nbsp;                if (newLead.Country != oldLead.Country) {</b>
<b class="fc"><i>112</i>&nbsp;                    leadIdsToProcess.add(leadId);</b>
<i>113</i>&nbsp;                }
<i>114</i>&nbsp;            }
<i>115</i>&nbsp;        }
<i>116</i>&nbsp;
<i>117</i>&nbsp;        // Query the campaign members only for the leads we want to process
<b class="fc"><i>118</i>&nbsp;        if (!leadIdsToProcess.isEmpty()) {</b>
<b class="fc"><i>119</i>&nbsp;            List&lt;CampaignMember&gt; campaignMembersLinked = [</b>
<i>120</i>&nbsp;                    SELECT CampaignId
<i>121</i>&nbsp;                    FROM CampaignMember
<b class="fc"><i>122</i>&nbsp;                    WHERE LeadId IN :leadIdsToProcess</b>
<i>123</i>&nbsp;            ];
<i>124</i>&nbsp;
<i>125</i>&nbsp;            // Add the CampaignId to the campaignsToProcess set
<b class="fc"><i>126</i>&nbsp;            for (CampaignMember cm : campaignMembersLinked) {</b>
<b class="fc"><i>127</i>&nbsp;                campaignsToProcess.add(cm.CampaignId);</b>
<i>128</i>&nbsp;            }
<i>129</i>&nbsp;        }
<i>130</i>&nbsp;
<b class="fc"><i>131</i>&nbsp;        return campaignsToProcess;</b>
<i>132</i>&nbsp;    }
<i>133</i>&nbsp;
<i>134</i>&nbsp;    /**
<i>135</i>&nbsp;     * It ensures that the newly converted Lead&#39;s information is reflected in associated campaign members.
<i>136</i>&nbsp;     * @author unknown
<i>137</i>&nbsp;     * @param oldLeadsValues old values
<i>138</i>&nbsp;     * @param newLeadsValues new values
<i>139</i>&nbsp;     */
<b class="fc"><i>140</i>&nbsp;    public static void updateCampaignMembers(Map&lt;Id, Lead&gt; oldLeadsValues, Map&lt;Id, Lead&gt; newLeadsValues)</b>
<i>141</i>&nbsp;    {
<b class="fc"><i>142</i>&nbsp;        Set&lt;Id&gt; leadIdSet = new Set&lt;Id&gt;();</b>
<b class="fc"><i>143</i>&nbsp;        Set&lt;Id&gt; campaignIDSId = new Set&lt;Id&gt;();</b>
<b class="fc"><i>144</i>&nbsp;        Map&lt;Id, Lead&gt; mapContactIdLead = new Map&lt;Id,Lead&gt;();</b>
<b class="fc"><i>145</i>&nbsp;        Boolean leadHasBeenConverted = false;</b>
<b class="fc"><i>146</i>&nbsp;        for(Lead newLead : newLeadsValues.values())</b>
<b class="fc"><i>147</i>&nbsp;        {</b>
<b class="fc"><i>148</i>&nbsp;            leadHasBeenConverted = newLead.IsConverted &amp;&amp; !oldLeadsValues.get(newLead.Id).IsConverted; // Wasn&#39;t converted and became</b>
<i>149</i>&nbsp;
<b class="fc"><i>150</i>&nbsp;            if(leadHasBeenConverted)</b>
<i>151</i>&nbsp;            {
<b class="nc"><i>152</i>&nbsp;                leadIdSet.add(newLead.ConvertedContactId);</b>
<b class="nc"><i>153</i>&nbsp;                if(newLead.IDSCampaign__c != &#39;&#39;)</b>
<i>154</i>&nbsp;                {
<b class="nc"><i>155</i>&nbsp;                    campaignIDSId.add(newLead.IDSCampaign__c);</b>
<b class="nc"><i>156</i>&nbsp;                    mapContactIdLead.put(newLead.ConvertedContactId , newLead);</b>
<i>157</i>&nbsp;                }
<i>158</i>&nbsp;            }
<i>159</i>&nbsp;        }
<i>160</i>&nbsp;        
<i>161</i>&nbsp;        //Find all Campaign Members related to the converted leads
<b class="fc"><i>162</i>&nbsp;        if(leadIdSet.size()&gt;0){</b>
<b class="nc"><i>163</i>&nbsp;        	List&lt;CampaignMember&gt; cmList = [SELECT Id, SalesLead__c, Opportunity__c, VoucherCode__c, URL_Source__c, LeadId, Description__c, HasResponded, ContactId, Brand__c, CampaignId, Dealer__c,</b>
<i>164</i>&nbsp;                    Campaign.Brand__c
<i>165</i>&nbsp;                                                FROM CampaignMember
<b class="nc"><i>166</i>&nbsp;                                                WHERE ContactId IN: leadIdSet AND Campaign.RecordType.DeveloperName =: &#39;Digital_Marketing_Campaign&#39;];</b>
<b class="nc"><i>167</i>&nbsp;        	Map&lt;Id, CampaignMember&gt; cmMap = new Map&lt;Id, CampaignMember&gt;(cmList);        </b>
<b class="nc"><i>168</i>&nbsp;       		CampaignMemberTriggerHelper.convertMemberToSalesLeadOrOpportunity(cmList, cmMap, true);</b>
<i>169</i>&nbsp;        }
<b class="fc"><i>170</i>&nbsp;        if(leadIdSet.size()&gt;0){</b>
<b class="nc"><i>171</i>&nbsp;        	List&lt;CampaignMember&gt; cmList = [SELECT Id, SalesLead__c, Opportunity__c, LeadId, Lead.IDSVoucherCode__c, Lead.IDSURLSource__c, Lead.IDSBrand__c, Lead.IDSDescription__c, Lead.IDSDealer__c,</b>
<i>172</i>&nbsp;                                                Description__c, HasResponded, ContactId, Brand__c, CampaignId, Dealer__c, Campaign.Brand__c
<i>173</i>&nbsp;                                            FROM CampaignMember
<b class="nc"><i>174</i>&nbsp;                                            WHERE ContactId IN: leadIdSet AND Campaign.RecordType.DeveloperName =: &#39;InPersonEventCampaign&#39; AND CampaignId IN: campaignIDSId];</b>
<b class="nc"><i>175</i>&nbsp;            for(integer i=0; i &lt; cmList.size(); i++){</b>
<b class="nc"><i>176</i>&nbsp;                cmList[i].VoucherCode__c = mapContactIdLead.get(cmList[i].ContactId).IDSVoucherCode__c;</b>
<b class="nc"><i>177</i>&nbsp;                cmList[i].Brand__c = mapContactIdLead.get(cmList[i].ContactId).IDSBrand__c;</b>
<b class="nc"><i>178</i>&nbsp;                cmList[i].Dealer__c = mapContactIdLead.get(cmList[i].ContactId).IDSDealer__c;</b>
<b class="nc"><i>179</i>&nbsp;                cmList[i].Description__c = mapContactIdLead.get(cmList[i].ContactId).IDSDescription__c;</b>
<b class="nc"><i>180</i>&nbsp;                cmList[i].URL_Source__c = mapContactIdLead.get(cmList[i].ContactId).IDSURLSource__c;</b>
<i>181</i>&nbsp;            }
<b class="nc"><i>182</i>&nbsp;            Map&lt;Id, CampaignMember&gt; cmMap = new Map&lt;Id, CampaignMember&gt;(cmList);</b>
<b class="nc"><i>183</i>&nbsp;       		CampaignMemberTriggerHelper.convertMemberToSalesLeadOrOpportunity(cmList, cmMap, true);</b>
<i>184</i>&nbsp;        }
<i>185</i>&nbsp;        
<i>186</i>&nbsp;    }
<i>187</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2024-12-10 16:19</div>
</div>
</body>
</html>
